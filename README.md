# SimHash Watermarking and Detection Project

This project focuses on implementing watermarking, paraphrasing, and detection techniques for text generated by language models. It uses the SimHash algorithm for embedding-based watermarking and includes utilities for generating watermarked text, paraphrased versions, and unrelated text to evaluate the performance of the watermarking scheme. The implementation allows for a systematic evaluation of watermark robustness under various conditions, such as paraphrasing attacks and unrelated text comparisons.

## File Descriptions

### 1. `experiments_simhash.py`

This script performs experiments to evaluate the SimHash watermarking and detection techniques. It generates watermarked text, paraphrased text, and unrelated text, computes their detection metrics, and visualizes the results.

#### Key Components:

- **Advanced Paraphrasing Methods**:
  - **Substitution Attack**: Randomly replaces tokens with others sampled from the vocabulary.
  - **Deletion Attack**: Removes a percentage of tokens from the input.
  - **Insertion Attack**: Inserts new tokens sampled from the vocabulary at random positions.
  - These methods allow control of intensity and attack type to create varied paraphrased versions of watermarked text, simulating real-world text perturbations.

- **`generate_unrelated_text`**: Dynamically generates unrelated text by sampling directly from the language model using controlled randomness. The unrelated text ensures no semantic or structural similarity to watermarked text.

- **`run_experiment`**: Main function to run the experiments. It:
  - Generates watermarked, paraphrased, and unrelated text.
  - Detects the watermark in each text type using SimHash detection methods.
  - Computes and visualizes average minimum costs for different text categories, helping to assess the robustness of the watermark under different scenarios.

#### Outputs:

- Saves the generated text and detection results to `text_outputs.txt`.
- Plots a bar chart visualizing the average minimum costs for watermarked, paraphrased, and unrelated text, highlighting the separation between categories.

### 2. `generate_simhash.py`

This module implements the watermarking logic using the SimHash algorithm.

#### Key Components:

- **`simple_encoder`**: Encodes input text into embeddings using the last hidden state of the language model. These embeddings serve as the basis for SimHash operations.
- **`SimHashWatermark`**: Class that implements the SimHash watermarking process:
  - Generates hash functions using precomputed Gaussian vectors.
  - Computes hash values and uses them to deterministically sample random vectors.
  - Provides flexibility in setting the number of hash functions (`k`) and bits per hash (`b`).
- **`generate_with_simhash`**: Main function to generate watermarked text by integrating SimHash with exponential minimum sampling for token selection. It ensures the watermark is embedded seamlessly into the text generation process.

### 3. `detection_simhash.py`

This module implements the watermark detection logic.

#### Key Components:

- **`simple_encoder`**: Encodes text into embeddings for consistent representation across modules.
- **`simhash_detect_with_permutation`**: Detects the watermark in a given token by:
  - Computing a test statistic for the observed token.
  - Performing a permutation test to compute a p-value.
  - Returning the p-value, detection result, and minimum cost to assess watermark presence.

### 4. `xi_histogram.py`

This script generates histograms of `xi` values for watermarked, paraphrased, and unrelated text. These histograms help visualize the distribution of sampled values used in the watermarking and detection process, offering insights into their separability.

#### Key Components:

- **`paraphrase_text`**: Uses advanced paraphrasing methods (substitution, insertion, deletion) to create perturbed versions of the watermarked text.
- **`generate_unrelated_text`**: Generates unrelated text dynamically from the model, ensuring no structural or semantic overlap with watermarked text.
- **Histograms**: Plots separate histograms for `xi` values of watermarked, paraphrased, and unrelated text, showing how these distributions differ under varying conditions.

### 5. `k_and_b_min_xi_heatmap.py`

This script visualizes the effect of varying SimHash parameters (`k` and `b`) on the detection of watermarked text using a heatmap.

#### Key Components:

- **`example_with_detection`**: Tests the watermarking and detection for different parameter combinations, ensuring robustness across configurations.
- **Heatmap Visualization**: Plots a heatmap of minimum `xi` values for various combinations of `k` (number of hash functions) and `b` (bits per hash). This helps identify optimal parameter settings.

### 6. `k_and_b_TPR_FPR_heatmaps.py`

This script evaluates the true positive and false positive rates for watermark detection under different parameter combinations (`k` and `b`).

#### Key Components:

- **`evaluate_detection`**: Computes TPR (True Positive Rate) and FPR (False Positive Rate) for different parameter settings, providing a comprehensive view of detection performance.
- **Heatmap Visualization**: Plots TPR and FPR heatmaps to analyze performance, highlighting the trade-offs between sensitivity and specificity.

### 7. `performance_by_paraphrasing.py`

This script evaluates watermark detection performance by varying the intensity of paraphrasing attacks.

#### Key Components:

- **`evaluate_by_paraphrasing_intensity`**: Computes detection rates for different paraphrasing intensities using substitution, deletion, and insertion attacks. This demonstrates the resilience of the watermark against text perturbations.
- **`plot_paraphrasing_performance`**: Visualizes the detection rates as a function of paraphrasing intensity, showing how the watermark holds up under increasingly severe attacks.

### 8. `test_simhash.py`

This script tests the SimHash watermarking and detection for different combinations of parameters (`k` and `b`) and visualizes the results as a heatmap.

#### Key Components:

- **`example_with_detection`**: Tests the watermarking and detection for different parameter combinations, assessing performance consistency.
- **Heatmap Visualization**: Plots a heatmap of p-values for various combinations of `k` (number of hash functions) and `b` (bits per hash).

### 9. `test_diff_models.py`

This script compares different watermarking techniques (e.g., SimHash, KGW, custom) for generating and detecting watermarked text.

#### Key Components:

- **`run_exp`**: Tests the EXP watermarking method, focusing on flexibility and control.
- **`run_kgw`**: Tests the KGW watermarking method, suitable for specific structured text use cases.
- **`run_custom`**: Tests the custom SimHash watermarking method, demonstrating modularity and adaptability.

## How to Use

1. **Install Dependencies:**
   Ensure you have Python 3.7+ and the following libraries installed:

   - `torch`
   - `transformers`
   - `matplotlib`
   - `numpy`

   Install them using pip:

   ```bash
   pip install torch transformers matplotlib numpy
   ```

2. **Run Experiments:**
   To run the main experiment script:

   ```bash
   python3 experiments_simhash.py
   ```

   This will generate watermarked, paraphrased, and unrelated text, compute detection metrics, and visualize the results.

3. **Test Parameter Combinations:**
   To evaluate the watermarking and detection for different `k` and `b` values:

   ```bash
   python3 test_simhash.py
   ```

4. **View Outputs:**

   - Generated text and metrics are saved to `text_outputs.txt`.
   - Plots and visualizations are displayed interactively.

## Project Structure

```
.
├── experiments_simhash.py      # Main experiment script
├── generate_simhash.py         # SimHash watermarking implementation
├── detection_simhash.py        # SimHash detection logic
├── test_simhash.py             # Parameter testing and visualization
├── xi_histogram.py             # Histogram visualization of xi values
├── k_and_b_min_xi_heatmap.py   # Heatmap visualization of min xi
├── k_and_b_TPR_FPR_heatmaps.py # TPR/FPR heatmaps for parameter evaluation
├── performance_by_paraphrasing.py # Paraphrasing intensity experiments
├── test_diff_models.py         # Testing and comparing different watermarking methods
└── README.md                   # Project documentation
```

## Customization

- **Text Generation Parameters:** Modify `k`, `b`, `m`, and `n` in the scripts to experiment with different watermarking configurations. Larger values of `k` and `b` increase robustness but may also impact performance.
- **Paraphrasing Logic:** Adjust attack types (substitution, deletion, insertion) and intensities for more realistic paraphrasing to simulate adversarial conditions.
- **Unrelated Text Generation:** Enhance the `generate_unrelated_text` function to use external APIs or more complex logic for generating unrelated text, enabling more comprehensive evaluations.

## Notes

- Ensure that the pretrained model (`facebook/opt-1.3b`) is downloaded correctly. Change the model name in the scripts if a different model is needed.
- The minimum cost values (`min_cost`) and `xi` distributions are key metrics for evaluating the effectiveness of the watermarking scheme. Histograms and heatmaps provide additional insights into parameter tuning and attack resilience.
